---
- name: install vpp startup with vlan interface pciid
  template:
    src: startup.conf
    dest: /etc/vpp/startup.conf

- name: install vpp interface setup
  template:
    src: vpp-interface.conf
    dest: /etc/vpp-interface.conf

- name: restart vpp service
  service:
    name: vpp
    state: restarted

- name: update plugins config for vpp
  template:
    src: ml2_conf.j2
    dest: /etc/neutron/plugin.ini

- name: enable python pip - RedHat
  yum:
    name: ['python-devel','python-pip']
  when: ansible_os_family == "RedHat"

- name: enable python pip - Debian
  yum:
    name: ['python-dev','python-pip']
  when: ansible_os_family == "Debian"

- name: get vpp plugin code
  git:
    repo: https://github.com/openstack/networking-vpp
    dest: /root/networking-vpp
    update: no

- name: install openstack networking-vpp plugin
  pip:
    name: /root/networking-vpp

- name: migrate neutron vpp database
  command: neutron-db-manage --subproject networking-vpp --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugin.ini upgrade head

- name: bring ex-slave interface down
  command: ifdown {{vlan_interface}}
  ignore_errors: true

- name: add vpp-agent script
  template:
    src: vpp-agent
    dest: /usr/local/bin/vpp-agent
    mode: 0755

- name: add vpp-agent systemd service
  template:
    src: vpp-agent.service
    dest: /usr/lib/systemd/system/vpp-agent.service
    mode: 0644

- name: add vpp-agent multi-user.wants link
  file:
    state: link
    src: /usr/lib/systemd/system/vpp-agent.service
    dest: /etc/systemd/system/multi-user.target.wants/vpp-agent.service
  notify:
  - Restart neutron-server
  - Restart vpp-agent

- name: add create_vlans.sh openstack client script
  template:
    src: create_vlans.sh
    dest: /root/create_vlans.sh
    mode: 0755
